(()=>{"use strict";var e={63:e=>{e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,s,o;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(s=r;0!=s--;)if(!e(t[s],n[s]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(o=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(s=r;0!=s--;)if(!Object.prototype.hasOwnProperty.call(n,o[s]))return!1;for(s=r;0!=s--;){var i=o[s];if(!e(t[i],n[i]))return!1}return!0}return t!=t&&n!=n}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{function e(e,t,n){return new Promise(((r,s)=>{const o=n.length,i=o-1;if(0===o)return r();const a=e.txn.objectStore(t);for(let t=0;t<n.length;t++){const o=a.delete(n[t]);o.onerror=()=>{e.abort(),s(o.error)},t===i&&(o.onsuccess=()=>{r()})}}))}function t(t,n,r,s){return 0===s.length?Promise.resolve([]):new Promise(((o,i)=>{const a=t.txn.objectStore(n).index(r),c=[];for(var l=0;l<s.length;l++){const r=a.getAllKeys(s[l]),u=l===s.length-1;r.onsuccess=()=>{c.push(...r.result),u&&e(t,n,c).then((()=>o(c)),i)},r.onerror=()=>{t.abort(),i(r.error)}}}))}function r(e){return null==e||e!=e?-1/0:!0===e?1:!1===e?0:e}function s(e,t){const n=Object.create(null,{});for(let s of Object.keys(e)){const o=e[s];Array.isArray(o)?n[s]=o.map(r):(s!==t||null!=o&&o!==-1/0)&&(n[s]=r(o))}return n}var o,i,a,c,l=n(63),u=n.n(l);!function(e){function t(e,t){return t.properties.some((t=>{const n=e.properties.find((e=>e.name===t.name));return t.type===c.Value&&a.isList(n.type)}))}function n(e){return 1===e.properties.length?e.properties[0].name:e.properties.map((e=>e.name))}e.isIndexMultiEntry=t,e.getKeyPath=n,e.matchesIndex=function(e,r,s){return s.name===r.name&&s.multiEntry===t(e,r)&&s.unique===r.unique&&u()(s.keyPath,n(r))}}(o||(o={})),function(e){e.getStoreName=function(e,t,n){return`_${e}_${t}_${n}`}}(i||(i={})),function(e){e.Bool="Bool",e.Int="Int",e.Float="Float",e.Long="Long",e.Double="Double",e.String="String",e.ByteList="ByteList",e.BoolList="BoolList",e.IntList="IntList",e.FloatList="FloatList",e.LongList="LongList",e.DoubleList="DoubleList",e.StringList="StringList"}(a||(a={})),function(e){e.isList=function(t){return[e.ByteList,e.BoolList,e.IntList,e.FloatList,e.LongList,e.DoubleList,e.StringList].includes(t)}}(a||(a={})),function(e){e.Value="Value",e.Hash="Hash",e.HashElements="HashElements"}(c||(c={}));class d{constructor(e,t,n,r){this.isar=e,this.name=t,this.sourceName=n,this.targetName=r,this.storeName=i.getStoreName(n,r,t)}getLinkEntry(e,t,n){return n&&([e,t]=[t,e]),{a:e,b:t}}static getLinkKeyRange(e){return IDBKeyRange.bound([e,-1/0],[e,1/0])}update(e,t,n,r,s){return 0===r.length&&0===s.length?Promise.resolve():new Promise(((o,i)=>{const a=e.txn.objectStore(this.storeName),c=0===s.length;for(let s=0;s<r.length;s++){let l=r[s];const u=a.add(this.getLinkEntry(n,l,t));c&&s===r.length-1&&(u.onsuccess=()=>{o()}),u.onerror=()=>{e.abort(),i(u.error)}}for(let r=0;r<s.length;r++){let c=s[r];const l=t?[c,n]:[n,c],u=a.delete(l);r===s.length-1&&(u.onsuccess=()=>{o()}),u.onerror=()=>{e.abort(),i(u.error)}}}))}clear(t,n,r){return new Promise(((s,o)=>{const i=t.txn.objectStore(this.storeName);if(r){const r=i.index(d.BacklinkIndex).getAllKeys(n);r.onsuccess=()=>{const n=r.result;if(n.length>0){const r=n.map((e=>e[1]));e(t,this.storeName,r).then(s,o)}else s()},r.onerror=()=>{t.abort(),o(r.error)}}else{const e=i.delete(d.getLinkKeyRange(n));e.onsuccess=()=>{s()},e.onerror=()=>{t.abort(),o(e.error)}}}))}}d.BacklinkIndex="backlink";class h{constructor(){this.cleared=!1,this.addedObjects=new Map,this.deletedObjectIds=new Set}registerChange(e,t){t?(this.addedObjects.set(e,t),this.deletedObjectIds.delete(e)):(this.deletedObjectIds.add(e),this.addedObjects.delete(e))}registerCleared(){this.addedObjects.clear(),this.deletedObjectIds.clear(),this.cleared=!0}}class f extends class{constructor(){this.collectionWatchers=new Set,this.objectWatchers=new Map,this.queryWatchers=new Set}watchLazy(e){return this.collectionWatchers.add(e),()=>this.collectionWatchers.delete(e)}watchObject(e,t){let n=this.objectWatchers.get(e);return null==n&&(n=new Set,this.objectWatchers.set(e,n)),n.add(t),()=>{n.size<=1?this.objectWatchers.delete(e):n.delete(t)}}watchQueryInternal(e,t,n){const r={callback:n,query:e,lazy:t};return this.queryWatchers.add(r),()=>this.queryWatchers.delete(r)}watchQuery(e,t){return this.watchQueryInternal(e,!1,t)}watchQueryLazy(e,t){return this.watchQueryInternal(e,!0,t)}notify(e,t){if(!e.cleared&&0===e.addedObjects.size&&0===e.deletedObjectIds.size)return;function n(e){if(e.lazy)e.callback();else{const n=t();e.query.findAll(n).then(e.callback)}}for(const e of this.collectionWatchers)e();let r;if(e.cleared||e.deletedObjectIds.size>0)for(const e of this.queryWatchers)n(e);else r=new Set(this.queryWatchers);if(e.cleared)for(const[t,n]of this.objectWatchers)for(let r of n)r(e.addedObjects.get(t));else{for(const t of e.deletedObjectIds){const e=this.objectWatchers.get(t);if(null!=e)for(let t of e)t(void 0)}for(const[t,s]of e.addedObjects){const e=this.objectWatchers.get(t);if(null!=e)for(let t of e)t(s);if(null!=r)for(const e of r)e.query.whereClauseAndFilterMatch(t,s)&&(n(e),r.delete(e))}}}}{constructor(e,t,n){super(),this.indexKeyPaths=new Map,this.isar=e,this.name=t.name,this.idName=t.idName,this.boolValues=t.properties.filter((e=>e.type==a.Bool||e.type==a.BoolList)).map((e=>e.name)),this.uniqueIndexes=t.indexes.filter((e=>e.unique)).map((e=>({name:e.name,accessors:e.properties.map((e=>e.name))}))),this.links=t.links.map((n=>new d(e,n.name,t.name,n.target))),this.backlinkStoreNames=n,this.multiEntryIndexes=t.indexes.filter((e=>o.isIndexMultiEntry(t,e))).map((e=>e.name)),this.indexKeyPaths=new Map(t.indexes.map((e=>[e.name,e.properties.map((e=>e.name))])))}getLink(e){return this.links.find((t=>t.name===e))}toObject(e){return function(e,t){const n={};for(let r of Object.keys(e)){const s=e[r];s===-1/0?n[r]=null:-1!==t.indexOf(r)?Array.isArray(s)?n[r]=s.map((e=>e===-1/0?null:e>0)):n[r]=1===s:Array.isArray(s)?n[r]=s.map((e=>e===-1/0?null:e)):n[r]=s}return n}(e,this.boolValues)}getId(e){return e[this.idName]}getIndexKeyPath(e){return this.indexKeyPaths.get(e)}isMultiEntryIndex(e){return this.multiEntryIndexes.includes(e)}prepareKey(e){return Array.isArray(e)?1==e.length?r(e[0]):e.map(r):r(e)}getInternal(e,t){return new Promise(((n,r)=>{let s=e.get(t);s.onsuccess=()=>{const e=s.result?this.toObject(s.result):void 0;n(e)},s.onerror=()=>{r(s.error)}}))}get(e,t){let n=e.txn.objectStore(this.name);return this.getInternal(n,t)}getByIndex(e,t,n){let r=e.txn.objectStore(this.name).index(t);return this.getInternal(r,this.prepareKey(n))}getAllInternal(e,t,n,r){return new Promise(((s,o)=>{const i=e.txn.objectStore(this.name),a=r?i.index(r):i,c=[];for(let e=0;e<t.length;e++){let r=a.get(t[e]);r.onsuccess=()=>{const e=r.result;e?c.push(this.toObject(e)):n&&c.push(void 0),c.length==t.length&&s(c)},r.onerror=()=>{o(r.error)}}}))}getAll(e,t){return this.getAllInternal(e,t,!0)}getAllByIndex(e,t,n){const r=n.map(this.prepareKey);return this.getAllInternal(e,r,!0,t)}put(e,t,n=!1){let r=e.txn.objectStore(this.name);return new Promise(((n,o)=>{const i=r.put(s(t,this.idName));i.onsuccess=()=>{const r=i.result;e.getChangeSet(this.name).registerChange(r,t),n(r)},i.onerror=()=>{e.abort(),o(i.error)}}))}putAll(e,t,n=!1){let r=e.txn.objectStore(this.name);if(n)throw"Replace on conflict not implemented";return new Promise(((n,o)=>{const i=[],a=e.getChangeSet(this.name);for(let c=0;c<t.length;c++){let l=s(t[c],this.idName);const u=r.put(l),d=this.getId(l);i.push(d),d?(a.registerChange(d,l),c===t.length-1&&(u.onsuccess=()=>{n(i)})):u.onsuccess=()=>{const e=u.result;i[c]=e,a.registerChange(e,l),c===t.length-1&&n(i)},u.onerror=()=>{e.abort(),o(u.error)}}}))}deleteLinks(n,r){if(0===this.links.length&&0===this.backlinkStoreNames.length)return Promise.resolve();const s=this.links.map((t=>e(n,t.storeName,r.map(d.getLinkKeyRange)))),o=this.backlinkStoreNames.map((e=>t(n,e,d.BacklinkIndex,r)));return Promise.all([...s,...o]).then((()=>{}))}delete(e,t){return new Promise(((n,r)=>{const s=e.txn.objectStore(this.name).delete(t);s.onsuccess=()=>{e.getChangeSet(this.name).registerChange(t),this.deleteLinks(e,[t]).then(n,r)},s.onerror=()=>{r(s.error)}}))}deleteByIndex(e,t,n){return new Promise(((r,s)=>{const o=e.txn.objectStore(this.name),i=o.index(t).getKey(this.prepareKey(n));i.onsuccess=()=>{const t=i.result;if(t){const n=o.delete(t);n.onsuccess=()=>{e.getChangeSet(this.name).registerChange(t),this.deleteLinks(e,[t]).then((()=>r(!0)),s)},n.onerror=()=>{s(n.error)}}else r(!1)},i.onerror=()=>{s(i.error)}}))}deleteAll(t,n){return e(t,this.name,n).then((()=>{const e=t.getChangeSet(this.name);for(let t of n)e.registerChange(t);return this.deleteLinks(t,n)}))}deleteAllByIndex(e,n,r){const s=r.map(this.prepareKey);return t(e,this.name,n,s).then((t=>{const n=e.getChangeSet(this.name);for(let e of t)n.registerChange(e);return this.deleteLinks(e,t).then((()=>t.length))}))}clear(e){return new Promise(((t,n)=>{const r=[this.name,...this.backlinkStoreNames,...this.links.map((e=>e.storeName))];for(let s=0;s<r.length;s++){const o=e.txn.objectStore(this.name).clear();o.onerror=()=>{n(o.error)},s===r.length-1&&(o.onsuccess=()=>{e.getChangeSet(this.name).registerCleared(),t()})}}))}}class m{constructor(e,t,n){this.isar=e,this.txn=t,this.active=!0,this.write=n,n&&(this.changes=new Map)}getChangeSet(e){let t=this.changes.get(e);return null==t&&(t=new h,this.changes.set(e,t)),t}commit(){return new Promise(((e,t)=>{this.active=!1,this.txn.oncomplete=()=>{this.changes&&this.isar.notifyWatchers(this.changes),e()},this.txn.onerror=()=>{t(this.txn.error)},this.txn.commit()}))}abort(){this.active&&(this.active=!1,this.txn.abort())}}Promise.resolve(!1),Promise.resolve(!0);var g=Promise.resolve();function p(e,t){return e||(e=0),new Promise((function(n){return setTimeout((function(){return n(t)}),e)}))}function b(){return Math.random().toString(36).substring(2)}var y=0,w=0;function v(){var e=(new Date).getTime();return e===y?1e3*e+ ++w:(y=e,w=0,1e3*e)}var k="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);const x={create:function(e){var t={messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),g}catch(e){return Promise.reject(e)}},canBeUsed:function(){if(k&&"undefined"==typeof window)return!1;if("function"==typeof BroadcastChannel){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1},type:"native",averageResponseTime:function(){return 150},microSeconds:v};var I=function(){function e(e){this.ttl=e,this.set=new Set,this.timeMap=new Map}return e.prototype.has=function(e){return this.set.has(e)},e.prototype.add=function(e){var t=this;this.timeMap.set(e,C()),this.set.add(e),setTimeout((function(){!function(e){for(var t=C()-e.ttl,n=e.set[Symbol.iterator]();;){var r=n.next().value;if(!r)return;if(!(e.timeMap.get(r)<t))return;e.timeMap.delete(r),e.set.delete(r)}}(t)}),0)},e.prototype.clear=function(){this.set.clear(),this.timeMap.clear()},e}();function C(){return(new Date).getTime()}function S(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var L="messages",P={durability:"relaxed"};function j(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function N(e){e.commit&&e.commit()}function M(e){e.closed||B(e).then((function(){return p(e.options.idb.fallbackInterval)})).then((function(){return M(e)}))}function B(e){return e.closed?g:e.messagesCallback?function(e,t){var n=e.transaction(L,"readonly",P),r=n.objectStore(L),s=[],o=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var i=r.getAll(o);return new Promise((function(e,t){i.onerror=function(e){return t(e)},i.onsuccess=function(t){e(t.target.result)}}))}return new Promise((function(e,i){var a=function(){try{return o=IDBKeyRange.bound(t+1,1/0),r.openCursor(o)}catch(e){return r.openCursor()}}();a.onerror=function(e){return i(e)},a.onsuccess=function(r){var o=r.target.result;o?o.value.id<t+1?o.continue(t+1):(s.push(o.value),o.continue()):(N(n),e(s))}}))}(e.db,e.lastCursorId).then((function(t){var n=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return n.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),g})):g}const _={create:function(e,t){return t=S(t),function(e){var t="pubkey.broadcast-channel-0-"+e,n=j().open(t);return n.onupgradeneeded=function(e){e.target.result.createObjectStore(L,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){n.onerror=function(e){return t(e)},n.onsuccess=function(){e(n.result)}}))}(e).then((function(n){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:b(),eMIs:new I(2*t.idb.ttl),writeBlockPromise:g,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},M(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,B(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,t,n){var r={uuid:t,time:(new Date).getTime(),data:n},s=e.transaction([L],"readwrite",P);return new Promise((function(e,t){s.oncomplete=function(){return e()},s.onerror=function(e){return t(e)},s.objectStore(L).add(r),N(s)}))}(e.db,e.uuid,t)})).then((function(){var t,n;0===(0,10,Math.floor(11*Math.random()+0))&&(t=e.db,n=e.options.idb.ttl,function(e,t){var n=(new Date).getTime()-t,r=e.transaction(L,"readonly",P),s=r.objectStore(L),o=[];return new Promise((function(e){s.openCursor().onsuccess=function(t){var s=t.target.result;if(s){var i=s.value;if(!(i.time<n))return N(r),void e(o);o.push(i),s.continue()}else e(o)}}))}(t,n).then((function(e){return function(e,t){var n=e.transaction([L],"readwrite",P).objectStore(L);return Promise.all(t.map((function(e){var t=n.delete(e);return new Promise((function(e){t.onsuccess=function(){return e()}}))})))}(t,e.map((function(e){return e.id})))})))})),e.writeBlockPromise},canBeUsed:function(){return!k&&!!j()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:v};function O(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function E(e){return"pubkey.broadcastChannel-"+e}function A(){if(k)return!1;var e=O();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}const D={create:function(e,t){if(t=S(t),!A())throw new Error("BroadcastChannel: localstorage cannot be used");var n=b(),r=new I(t.localstorage.removeTimeout),s={channelName:e,uuid:n,eMIs:r};return s.listener=function(e,t){var o=E(e),i=function(e){var t;e.key===o&&(t=JSON.parse(e.newValue),s.messagesCallback&&t.uuid!==n&&t.token&&!r.has(t.token)&&(t.data.time&&t.data.time<s.messagesCallbackTime||(r.add(t.token),s.messagesCallback(t.data))))};return window.addEventListener("storage",i),i}(e),s},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){p().then((function(){var r=E(e.channelName),s={token:b(),time:(new Date).getTime(),data:t,uuid:e.uuid},o=JSON.stringify(s);O().setItem(r,o);var i=document.createEvent("Event");i.initEvent("storage",!0,!0),i.key=r,i.newValue=o,window.dispatchEvent(i),n()}))}))},canBeUsed:A,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:v};var W=v,K=new Set;const T={create:function(e){var t={name:e,messagesCallback:null};return K.add(t),t},close:function(e){K.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){return setTimeout((function(){Array.from(K).filter((function(t){return t.name===e.name})).filter((function(t){return t!==e})).filter((function(e){return!!e.messagesCallback})).forEach((function(e){return e.messagesCallback(t)})),n()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:W};var R=[x,_,D],q=new Set,F=0,z=function(e,t){var n,r,s;this.id=F++,q.add(this),this.name=e,this.options=S(t),this.method=function(e){var t=[].concat(e.methods,R).filter(Boolean);if(e.type){if("simulate"===e.type)return T;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||k||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No useable method found in "+JSON.stringify(R.map((function(e){return e.type}))))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,(s=r=(n=this).method.create(n.name,n.options))&&"function"==typeof s.then?(n._prepP=r,r.then((function(e){n._state=e}))):n._state=r};function V(e,t,n){var r={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:g).then((function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function H(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function Q(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&H(e)){var t=function(t){e._addEL[t.type].forEach((function(e){var n=e.time-1e5;t.time>=n&&e.fn(t.data)}))},n=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,n)})):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function J(e,t,n){e._addEL[t]=e._addEL[t].filter((function(e){return e!==n})),function(e){if(e._iL&&!H(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}z._pubkey=!0,z.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return V(this,"message",e)},postInternal:function(e){return V(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};J(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,Q(this,"message",t)):this._onML=null},addEventListener:function(e,t){Q(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){J(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){q.delete(this),this.closed=!0;var t=this._prepP?this._prepP:g;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};class U{constructor(e,t,n){this.collections=new Map,this.db=e,this.relaxedDurability=t,this.initializeCollections(n),this.eventHandler=e=>{e.data&&"change"===e.data.type&&e.data.instance==this.db.name&&this.notifyWatchers(e.data.changes,!0)},U.bc.addEventListener("message",this.eventHandler)}initializeCollections(e){for(let t of e){const n=e.flatMap((e=>e.name===t.name?[]:e.links.filter((e=>e.target===t.name)).map((t=>i.getStoreName(e.name,t.target,t.name))))),r=new f(this,t,n);this.collections.set(t.name,r)}}notifyWatchers(e,t=!1){let n;const r=()=>(null==n&&(n=this.beginTxn(!1)),n);for(let[t,n]of e.entries())this.getCollection(t).notify(n,r);if(!t){const t={type:"change",instance:this.db.name,changes:e};U.bc.postMessage(t)}}beginTxn(e){const t=this.db.objectStoreNames,n=e?"readwrite":"readonly",r=this.relaxedDurability?{durability:"relaxed"}:{},s=this.db.transaction(t,n,r);return new m(this,s,e)}getCollection(e){return this.collections.get(e)}close(e=!1){if(U.bc.removeEventListener("message",this.eventHandler),this.db.close(),e){const e=indexedDB.deleteDatabase(this.db.name);return new Promise(((t,n)=>{e.onsuccess=()=>{t()},e.onerror=()=>{n(e.error)}}))}return Promise.resolve()}}function $(e,t,n,r){return new Promise(((s,o)=>{const i=indexedDB.open(e,r);i.onsuccess=()=>{const o=i.result;if(null==r){const r=o.transaction(o.objectStoreNames,"readonly");if(!G(r,!0,t)){const i=r.db.version+1;return o.close(),void s($(e,t,n,i))}}const a=new U(o,n,t);s(a)},i.onupgradeneeded=()=>{G(i.transaction,!1,t)},i.onerror=()=>{o(i.error)}}))}function G(e,t,n){const r=[];for(let s of n){r.push(s.name);const n=[];let a;if(e.objectStoreNames.contains(s.name))a=e.objectStore(s.name);else{if(t)return!1;a=e.db.createObjectStore(s.name,{keyPath:s.idName,autoIncrement:!0})}for(let e of s.indexes){if(n.push(e.name),a.indexNames.contains(e.name)){const n=a.index(e.name);if(o.matchesIndex(s,e,n))continue;t||a.deleteIndex(e.name)}if(t)return!1;a.createIndex(e.name,o.getKeyPath(e),{unique:e.unique,multiEntry:o.isIndexMultiEntry(s,e)})}for(let n of s.links){const o=i.getStoreName(s.name,n.target,n.name);let a;if(e.objectStoreNames.contains(o))a=e.objectStore(o);else{if(t)return!1;a=e.db.createObjectStore(o,{keyPath:["a","b"],autoIncrement:!1})}if(r.push(o),!u()([...a.indexNames],[d.BacklinkIndex])){if(t)return!1;for(let e of a.indexNames)a.deleteIndex(e);a.createIndex(d.BacklinkIndex,"b")}}for(let e of a.indexNames)if(-1===n.indexOf(e)){if(t)return!1;a.deleteIndex(e)}}for(let n of e.objectStoreNames)if(-1===r.indexOf(n)){if(t)return!1;e.db.deleteObjectStore(n)}return!0}function X(e){return new Promise(((t,n)=>{const r=e.txn.txn.objectStore(e.storeName),s=null!=e.indexName?r.index(e.indexName):r,o=e.indexName&&s.multiEntry,i=s.openCursor(e.range,e.direction);i.onsuccess=()=>{const r=i.result;if(r)if(e.offset)r.advance(e.offset),e.offset=void 0;else{if(o&&!Array.isArray(r.value[s.keyPath]))return void r.continue();e.callback(r.primaryKey,r.value,(function(){r.continue()}),t,n)}else t()},i.onerror=e=>{n(e)}}))}U.bc=new z("ISAR_CHANNEL"),window.openIsar=function(e,t,n){return $(e,t,n)},window.IsarInstance=U,window.IsarTxn=m,window.IsarCollection=f,window.IsarQuery=class{constructor(e,t,n,r,s,o,i,a,c){this.collection=e,this.whereClauses=t,this.filter=s,this.sortCmp=o,this.distinctValue=i,this.offset=null!=a?a:0,this.limit=null!=c?c:1/0,this.whereClauseDirection=n?r?"nextunique":"prevunique":r?"next":"prev",0===this.whereClauses.length&&this.whereClauses.push({})}getWhereClauseRange(e){var t;return null!==(t=e.range)&&void 0!==t?t:IDBKeyRange.lowerBound(-1/0)}async findInternal(e,t){const n=this.offset,r=this.sortCmp?1/0:n+t,s=this.sortCmp?void 0:this.distinctValue;let o=[];const i=new Set,a=new Set,c=(e,t,n,c)=>{if(i.has(e))n();else if(i.add(e),!this.filter||this.filter(e,t)){if(s){const e=s(t);if(a.has(e))return void n();a.add(e)}o.push(t),o.length<r?n():c()}else n()};for(const t of this.whereClauses){if(o.length>=r)break;if("linkName"in t){const n=this.collection.isar.getCollection(t.linkCollection).getLink(t.linkName);await X({txn:e,storeName:n.storeName,indexName:t.backlink?d.BacklinkIndex:void 0,range:d.getLinkKeyRange(t.id),direction:this.whereClauseDirection,callback:(n,r,s,o,i)=>{const a=n[t.backlink?0:1];this.collection.get(e,a).then((e=>{e?c(a,e,s,o):s()})).catch((()=>i()))}})}else{const n=this.getWhereClauseRange(t);await X({txn:e,storeName:this.collection.name,indexName:"indexName"in t?t.indexName:void 0,range:n,direction:this.whereClauseDirection,callback:c})}}if(this.sortCmp){o.sort(this.sortCmp);const e=this.distinctValue;e&&(o=o.filter((t=>{const n=e(t);return!a.has(n)&&(a.add(n),!0)})))}return o.slice(n,n+t)}findFirst(e){return this.findInternal(e,1).then((e=>e.length>0?this.collection.toObject(e[0]):void 0))}findAll(e){var t;return this.findInternal(e,null!==(t=this.limit)&&void 0!==t?t:1/0).then((e=>e.map((e=>this.collection.toObject(e)))))}deleteFirst(e){return this.findInternal(e,1).then((t=>0!==t.length&&this.collection.delete(e,this.collection.getId(t[0])).then((()=>!0))))}deleteAll(e){return this.findInternal(e,this.limit).then((t=>this.collection.deleteAll(e,t.map(this.collection.getId)).then((()=>t.length))))}min(e,t){return this.findAll(e).then((e=>{let n;for(const r of e){const e=r[t];null!=e&&(null==n||e<n)&&(n=e)}return n}))}max(e,t){return this.findAll(e).then((e=>{let n;for(const r of e){const e=r[t];null!=e&&(null==n||e>n)&&(n=e)}return n}))}sum(e,t){return this.findAll(e).then((e=>{let n=0;for(const r of e){const e=r[t];null!=e&&(n+=e)}return n}))}average(e,t){return this.findAll(e).then((e=>{let n=0,r=0;for(const s of e){const e=s[t];null!=e&&(n+=e,r++)}return n/r}))}count(e){return this.findAll(e).then((e=>e.length))}whereClauseMatches(e,t){for(const n of this.whereClauses){if("linkName"in n)return!0;if("indexName"in n)if(this.collection.isMultiEntryIndex(n.indexName)){const e=t[this.collection.getIndexKeyPath(n.indexName)[0]];for(let t of e)if(this.getWhereClauseRange(n).includes(t))return!0}else{let r=this.collection.getIndexKeyPath(n.indexName).map((n=>n===this.collection.idName?e:t[n]));if(1===r.length&&(r=r[0]),this.getWhereClauseRange(n).includes(r))return!0}else if(this.getWhereClauseRange(n).includes(e))return!0}return!1}whereClauseAndFilterMatch(e,t){return!(!this.whereClauseMatches(e,t)||this.filter&&!this.filter(e,t))}},window.IsarLink=d})()})();
//# sourceMappingURL=index.js.map